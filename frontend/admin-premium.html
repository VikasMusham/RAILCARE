<!-- Floating Emergency Test Button (for admin demo/testing) -->
  <!-- Only one button, after chat panel in DOM -->
  <script src="socketio-loader.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
        <link rel="icon" type="image/png" href="favicon.png">
      <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RailMitra ‚Ä¢ Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --pure-black: #000000;
      --rich-black: #0a0a0a;
      --charcoal: #141414;
      --graphite: #1a1a1a;
      --slate: #252525;
      --steel: #333333;
      --silver: #666666;
      --pearl: #999999;
      --cloud: #cccccc;
      --snow: #f5f5f5;
      --pure-white: #ffffff;
      
      --emerald: #10b981;
      --amber: #f59e0b;
      --ruby: #ef4444;
      --sapphire: #3b82f6;
      --violet: #8b5cf6;
      
      --text-xs: 11px;
      --text-sm: 13px;
      --text-base: 15px;
      --text-lg: 17px;
      --text-xl: 20px;
      --text-2xl: 24px;
      --text-3xl: 32px;
      --text-4xl: 40px;
      
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
      --duration-fast: 150ms;
      --duration-base: 250ms;
    }

    body {
      --bg-primary: var(--pure-white);
      --bg-secondary: var(--snow);
      --bg-tertiary: var(--cloud);
      --text-primary: var(--pure-black);
      --text-secondary: var(--silver);
      --text-tertiary: var(--pearl);
      --border-color: rgba(0, 0, 0, 0.08);
      --card-bg: var(--pure-white);
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 8px 32px rgba(0, 0, 0, 0.04);
      --input-bg: var(--snow);
    }

    body.dark {
      --bg-primary: var(--rich-black);
      --bg-secondary: var(--charcoal);
      --bg-tertiary: var(--graphite);
      --text-primary: var(--pure-white);
      --text-secondary: var(--pearl);
      --text-tertiary: var(--silver);
      --border-color: rgba(255, 255, 255, 0.08);
      --card-bg: var(--graphite);
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 8px 32px rgba(0, 0, 0, 0.2);
      --input-bg: var(--slate);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* Navigation */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: var(--space-4) var(--space-8);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      backdrop-filter: blur(20px);
    }

    .navbar-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      text-decoration: none;
      color: var(--text-primary);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--text-primary);
      color: var(--bg-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-size: var(--text-xl);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .nav-link {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      transition: color var(--duration-fast) var(--ease-out);
    }

    .nav-link:hover, .nav-link.active {
      color: var(--text-primary);
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      position: relative;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .theme-toggle:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-primary {
      padding: var(--space-3) var(--space-6);
      background: var(--text-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Main Container */
    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 100px var(--space-8) var(--space-16);
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-8);
    }

    .page-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
    }

    .page-title {
      font-size: var(--text-4xl);
      font-weight: 800;
      letter-spacing: -2px;
      margin-bottom: var(--space-3);
    }

    .page-description {
      font-size: var(--text-lg);
      color: var(--text-secondary);
    }

    .header-actions {
      display: flex;
      gap: var(--space-3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--space-5);
      margin-bottom: var(--space-8);
    }

    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      box-shadow: var(--card-shadow);
    }

    .stat-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-2);
    }

    .stat-value {
      font-size: var(--text-2xl);
      font-weight: 800;
      letter-spacing: -1px;
    }

    .stat-change {
      font-size: var(--text-xs);
      margin-top: var(--space-2);
    }

    .stat-change.up { color: var(--emerald); }
    .stat-change.down { color: var(--ruby); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: var(--space-1);
      background: var(--bg-secondary);
      padding: var(--space-1);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }

    .tab {
      padding: var(--space-3) var(--space-6);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all var(--duration-fast) var(--ease-out);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--card-bg);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tab-badge {
      padding: var(--space-1) var(--space-2);
      background: var(--ruby);
      color: white;
      border-radius: var(--radius-full);
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      text-align: center;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--card-shadow);
      margin-bottom: var(--space-6);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-5);
    }

    .card-title {
      font-size: var(--text-lg);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* Buttons */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }

    .btn-dark {
      background: var(--text-primary);
      color: var(--bg-primary);
    }

    .btn-dark:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }

    .btn-success { background: var(--emerald); color: white; }
    .btn-danger { background: var(--ruby); color: white; }
    .btn-warning { background: var(--amber); color: white; }

    .btn-sm {
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-xs);
    }

    /* Form */
    .form-row {
      display: flex;
      gap: var(--space-4);
      align-items: center;
      flex-wrap: wrap;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .form-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select {
      padding: var(--space-2) var(--space-4);
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      color: var(--text-primary);
      min-width: 150px;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--text-primary);
    }

    /* Application Cards */
    .app-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .app-card:hover {
      background: var(--bg-tertiary);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .app-user {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .app-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      border: 2px solid var(--border-color);
      overflow: hidden;
    }

    .app-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .app-name {
      font-size: var(--text-lg);
      font-weight: 600;
    }

    .app-station {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .app-status {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending { background: rgba(245, 158, 11, 0.1); color: var(--amber); }
    .status-approved { background: rgba(16, 185, 129, 0.1); color: var(--emerald); }
    .status-rejected { background: rgba(239, 68, 68, 0.1); color: var(--ruby); }

    .app-details {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .app-detail-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      margin-bottom: 2px;
    }

    .app-detail-value {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .app-docs {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .doc-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      color: var(--text-primary);
      text-decoration: none;
      transition: all var(--duration-fast) var(--ease-out);
    }

    .doc-link:hover {
      background: var(--bg-tertiary);
    }

    .app-actions {
      display: flex;
      gap: var(--space-3);
      padding-top: var(--space-4);
      border-top: 1px solid var(--border-color);
    }

    /* Booking Items */
    .booking-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
      align-items: center;
    }

    .booking-item:hover {
      background: var(--bg-tertiary);
    }

    .booking-passenger {
      font-weight: 600;
    }

    .booking-meta {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    /* Audit Log */
    .audit-item {
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .audit-action {
      font-weight: 600;
      margin-bottom: var(--space-1);
    }

    .audit-meta {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-4);
      opacity: 0.3;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: var(--space-8);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }

    .modal-title {
      font-size: var(--text-xl);
      font-weight: 700;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    .modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .modal .form-group {
      margin-bottom: var(--space-4);
    }

    .modal .form-input, .modal .form-select {
      width: 100%;
      padding: var(--space-3) var(--space-4);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .app-details {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .nav-links {
        display: none;
      }
      .tabs {
        overflow-x: auto;
      }
      .booking-item {
        grid-template-columns: 1fr;
      }
      .page-header {
        flex-direction: column;
        gap: var(--space-4);
      }
    }

    /* Loading */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Profile Dropdown Styles */
    .profile-section {
      display: none;
      align-items: center;
      gap: var(--space-3);
    }

    .profile-section.active {
      display: flex;
    }

    .profile-trigger {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      background: var(--bg-secondary);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      border: 1px solid var(--border-color);
    }

    .profile-trigger:hover {
      background: var(--bg-tertiary);
    }

    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--emerald), var(--sapphire));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: var(--text-sm);
      color: white;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      display: flex;
      flex-direction: column;
    }

    .profile-greeting {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .profile-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .profile-dropdown-icon {
      color: var(--text-secondary);
      transition: transform var(--duration-fast) var(--ease-out);
    }

    .profile-trigger.open .profile-dropdown-icon {
      transform: rotate(180deg);
    }

    .profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 280px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--card-shadow-hover);
      border: 1px solid var(--border-color);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all var(--duration-fast) var(--ease-out);
      z-index: 1000;
      overflow: hidden;
    }

    .profile-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-header {
      padding: var(--space-5);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .dropdown-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--emerald), var(--sapphire));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-xl);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .dropdown-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-upload {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      text-align: center;
      padding: 2px;
      cursor: pointer;
      opacity: 0;
      transition: opacity var(--duration-fast);
    }

    .dropdown-avatar:hover .avatar-upload {
      opacity: 1;
    }

    .dropdown-user-info h4 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .dropdown-user-info p {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .dropdown-menu {
      padding: var(--space-2);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      text-decoration: none;
      font-size: var(--text-sm);
      transition: background var(--duration-fast);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .dropdown-item:hover {
      background: var(--bg-secondary);
    }

    .dropdown-item svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .dropdown-item.danger {
      color: var(--ruby);
    }

    .dropdown-item.danger svg {
      color: var(--ruby);
    }

    .dropdown-divider {
      height: 1px;
      background: var(--border-color);
      margin: var(--space-2) 0;
    }

    .sign-in-btn {
      display: inline-flex;
    }

    .sign-in-btn.hidden {
      display: none;
    }

    /* Settings Modal */
    .settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--duration-base);
    }

    .settings-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .settings-content {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 80px rgba(0,0,0,0.3);
    }

    .settings-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .settings-header h3 {
      font-size: var(--text-xl);
      font-weight: 600;
    }

    .settings-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }

    .settings-body {
      padding: var(--space-6);
    }

    .settings-section {
      margin-bottom: var(--space-6);
    }

    .settings-section h4 {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-4);
    }

    .settings-avatar-section {
      display: flex;
      align-items: center;
      gap: var(--space-5);
      margin-bottom: var(--space-6);
    }

    .settings-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--emerald), var(--sapphire));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-3xl);
      color: white;
      overflow: hidden;
    }

    .settings-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .settings-avatar-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .avatar-upload-btn {
      padding: var(--space-2) var(--space-4);
      background: var(--text-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
    }

    .avatar-remove-btn {
      padding: var(--space-2) var(--space-4);
      background: transparent;
      color: var(--ruby);
      border: 1px solid var(--ruby);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
    }

    .settings-input-group {
      margin-bottom: var(--space-4);
    }

    .settings-input-group label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      margin-bottom: var(--space-2);
      color: var(--text-primary);
    }

    .settings-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      color: var(--text-primary);
    }

    .settings-input:focus {
      outline: none;
      border-color: var(--text-primary);
    }

    .settings-footer {
      padding: var(--space-6);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
    }

    .settings-save-btn {
      padding: var(--space-3) var(--space-6);
      background: var(--text-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
    }

    .settings-cancel-btn {
      padding: var(--space-3) var(--space-6);
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
    }

    #avatarInput {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="passenger-premium.html" class="logo">
        <div class="logo-icon">üöÑ</div>
        <span class="logo-text">RailMitra</span>
      </a>
      
      <div class="nav-links">
        <a href="admin-premium.html" class="nav-link active">Admin Panel</a>
        <a href="admin-dashboard.html" class="nav-link" style="color: var(--sapphire);">Super Dashboard</a>
      </div>
        <!-- Emergency Alert Notification -->
        <div id="emergencyAlert" style="display:none; position:fixed; right:32px; bottom:110px; z-index:100000; background:#ef4444; color:#fff; padding:18px 28px; border-radius:16px; box-shadow:0 4px 24px rgba(0,0,0,0.18); font-size:18px; font-weight:600; cursor:pointer; transition:all 0.2s;">
          üö® New Emergency Chat! Click to respond
        </div>
          <script>
          // Emergency Alert Notification for Admin
          let lastAlertBookingId = null;
          function showEmergencyAlert(bookingId, passengerName) {
            const alertDiv = document.getElementById('emergencyAlert');
            alertDiv.style.display = 'block';
            lastAlertBookingId = bookingId;
            alertDiv.setAttribute('data-passenger', passengerName || '');
          }
          function hideEmergencyAlert() {
            document.getElementById('emergencyAlert').style.display = 'none';
            lastAlertBookingId = null;
          }
          document.getElementById('emergencyAlert').onclick = function() {
            // Always use the latest bookingId and passenger from the alert
            if (lastAlertBookingId) {
              const passengerName = document.getElementById('emergencyAlert').getAttribute('data-passenger') || '';
              openAdminChatPanel(lastAlertBookingId, passengerName);
              hideEmergencyAlert();
            } else {
              // Fallback: find the most recent bookingId from unread chats
              const unreadIds = Object.keys(window._adminUnreadChats || {});
              if (unreadIds.length > 0) {
                openAdminChatPanel(unreadIds[0]);
                hideEmergencyAlert();
              } else {
                alert('No active emergency chat to open.');
              }
            }
          };
          // Listen for new emergency chat events
          // --- Background listener for all emergency chats ---
          (function listenForEmergencyChats() {
            if (!window.io) {
              document.addEventListener('socketio-ready', listenForEmergencyChats, { once: true });
              return;
            }
            const alertSocket = io('http://localhost:3000');
            // Track unread messages per bookingId
            window._adminUnreadChats = {};
            alertSocket.on('emergency_chat', data => {
              if (data && data.bookingId) {
                showEmergencyAlert(data.bookingId, data.user);
                // Mark as unread if chat panel is not open for this booking
                if (window.adminCurrentBookingId !== data.bookingId || document.getElementById('emergencyChatPanel').style.display !== 'block') {
                  window._adminUnreadChats[data.bookingId] = (window._adminUnreadChats[data.bookingId] || 0) + 1;
                  updateEmergencyAlertBadge();
                }
              }
            });
            function updateEmergencyAlertBadge() {
              const alertDiv = document.getElementById('emergencyAlert');
              let badge = document.getElementById('emergencyAlertBadge');
              const totalUnread = Object.values(window._adminUnreadChats).reduce((a,b)=>a+b,0);
              if (totalUnread > 0) {
                if (!badge) {
                  badge = document.createElement('span');
                  badge.id = 'emergencyAlertBadge';
                  badge.style = 'background:#fff;color:#ef4444;font-weight:700;border-radius:50%;padding:2px 8px;font-size:13px;position:absolute;top:8px;right:12px;';
                  alertDiv.appendChild(badge);
                }
                badge.textContent = totalUnread;
              } else if (badge) {
                badge.remove();
              }
            }
            // When admin opens a chat, clear unread for that booking
            window.addEventListener('open-admin-chat', function(e) {
              if (e.detail && e.detail.bookingId) {
                delete window._adminUnreadChats[e.detail.bookingId];
                updateEmergencyAlertBadge();
              }
            });
          })();
          </script>
<!-- Emergency Chat Panel (moved to end of body for proper overlay) -->

        <!-- Emergency Chat Panel (Admin) -->
        <!-- Removed duplicate emergencyChatPanel (fixed) to avoid overlay issues. Only the one in the tabs section remains. -->
        <script>
        // Emergency Chat Panel for Admin
        let adminChatSocket, adminCurrentBookingId = null, adminUserName = 'Admin';
        // Listen for emergency chat events from backend
        function openAdminChatPanel(bookingId, passengerName) {
          const panel = document.getElementById('emergencyChatPanel');
          if (panel) panel.style.display = 'block';
          adminCurrentBookingId = bookingId;
          // Show bookingId and passenger name for debug
          let infoDiv = document.getElementById('adminChatBookingIdInfo');
          if (!infoDiv) {
            infoDiv = document.createElement('div');
            infoDiv.id = 'adminChatBookingIdInfo';
            infoDiv.style = 'color:#10b981;font-size:13px;padding:4px 12px;';
            panel.insertBefore(infoDiv, panel.firstChild.nextSibling);
          }
          infoDiv.textContent = 'Booking ID: ' + bookingId + (passengerName ? ' | Passenger: ' + passengerName : '');
          // Fire event to clear unread
          window.dispatchEvent(new CustomEvent('open-admin-chat', { detail: { bookingId } }));
          setupAdminChatSocket();
        }
        function closeAdminChatPanel() {
          document.getElementById('emergencyChatPanel').style.display = 'none';
          if (adminChatSocket) adminChatSocket.disconnect();
          adminCurrentBookingId = null;
        }
        function setupAdminChatSocket() {
          console.log('[Admin] setupAdminChatSocket called for bookingId:', adminCurrentBookingId);
          if (!window.io) {
            document.addEventListener('socketio-ready', setupAdminChatSocket, { once: true });
            return;
          }
          if (adminChatSocket) adminChatSocket.disconnect();
          adminChatSocket = io('http://localhost:3000');
          console.log('[Admin] Emitting join for bookingId:', adminCurrentBookingId);
          adminChatSocket.emit('join', { role: 'admin', bookingId: adminCurrentBookingId });
          const chatBox = document.getElementById('adminChatList');
          chatBox.innerHTML = '';
          document.getElementById('adminChatInput').value = '';
          adminChatSocket.on('chat_history', msgs => {
            console.log('[Admin Chat] Received chat_history:', msgs);
            chatBox.innerHTML = '';
            if (msgs.length === 0) {
              const info = document.createElement('div');
              info.id = 'adminNoMessages';
              info.style = 'color:#888; text-align:center; margin:24px 0; font-size:15px;';
              info.textContent = 'No messages yet.';
              chatBox.appendChild(info);
            } else {
              msgs.forEach(m => appendAdminChatMessage(m));
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          });
          adminChatSocket.on('chat_message', msg => {
            // Debug: Show incoming message bookingId and current admin bookingId
            // ...existing code...
            console.log('[Admin Chat] Received chat_message:', msg, 'adminCurrentBookingId:', adminCurrentBookingId);
            // Only append if the chat panel is open for this booking
            if (adminCurrentBookingId === msg.bookingId && document.getElementById('emergencyChatPanel').style.display === 'block') {
              appendAdminChatMessage(msg);
              chatBox.scrollTop = chatBox.scrollHeight;
              document.getElementById('adminNoMessages')?.remove();
            } else {
              // If not open, increment unread count for this booking
              window._adminUnreadChats = window._adminUnreadChats || {};
              window._adminUnreadChats[msg.bookingId] = (window._adminUnreadChats[msg.bookingId] || 0) + 1;
              // Optionally, show alert or badge (already handled by emergency_alert logic)
            }
          });
          adminChatSocket.on('typing', user => {
            document.getElementById('adminTypingIndicator').textContent = user + ' is typing...';
          });
          adminChatSocket.on('stop_typing', () => {
            document.getElementById('adminTypingIndicator').textContent = '';
          });
        }
        function sendAdminChatMessage() {
          const input = document.getElementById('adminChatInput');
          const msg = input.value.trim();
          if (!msg || !adminChatSocket) return;
          const messageObj = { bookingId: adminCurrentBookingId, user: adminUserName, text: msg, time: new Date().toISOString() };
          adminChatSocket.emit('chat_message', messageObj);
          input.value = '';
          document.getElementById('adminTypingIndicator').textContent = '';
        }
        function appendAdminChatMessage(msg) {
          const chatBox = document.getElementById('adminChatList');
          const isSelf = msg.user === adminUserName;
          const div = document.createElement('div');
          div.style = `margin-bottom:6px; text-align:${isSelf ? 'right':'left'};`;
          div.innerHTML = `<span style="display:inline-block; background:${isSelf ? '#10b981':'#444'}; color:#fff; border-radius:8px; padding:6px 12px; max-width:70%; word-break:break-word;">${msg.text}</span><span style="font-size:10px; color:#aaa; margin-left:6px;">${new Date(msg.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
          chatBox.appendChild(div);
        }
        document.addEventListener('DOMContentLoaded', function() {
          const input = document.getElementById('adminChatInput');
          if (input) {
            input.addEventListener('input', function() {
              if (adminChatSocket) adminChatSocket.emit('typing', { bookingId: adminCurrentBookingId, user: adminUserName });
              clearTimeout(window._adminTypingTimeout);
              window._adminTypingTimeout = setTimeout(() => {
                if (adminChatSocket) adminChatSocket.emit('stop_typing', { bookingId: adminCurrentBookingId, user: adminUserName });
              }, 1200);
            });
          }
        });
        // Hook up emergency help button in bookings to open chat
        function adminEmergencyHelp(bookingId) {
          openAdminChatPanel(bookingId);
        }
        window.adminEmergencyHelp = adminEmergencyHelp;
        </script>
      
      <div class="nav-actions">
        <!-- Emergency button and chat panel removed from navbar as per request -->
        <button class="theme-toggle" onclick="toggleTheme()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
          </svg>
        </button>
        
        <!-- Sign In Button (shown when not logged in) -->
        <a href="login-premium.html" class="btn-primary sign-in-btn" id="signInBtn">Sign In</a>
        
        <!-- Profile Section (shown when logged in) -->
        <div class="profile-section" id="profileSection">
          <div class="profile-trigger" onclick="toggleProfileDropdown()">
            <div class="profile-avatar" id="navAvatar">
              <span id="navAvatarInitials">A</span>
              <img id="navAvatarImg" src="" alt="" style="display: none;">
            </div>
            <div class="profile-info">
              <span class="profile-greeting">Hello,</span>
              <span class="profile-name" id="navUserName">Admin</span>
            </div>
            <svg class="profile-dropdown-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          
          <!-- Dropdown Menu -->
          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
              <div class="dropdown-avatar" id="dropdownAvatar">
                <span id="dropdownAvatarInitials">A</span>
                <img id="dropdownAvatarImg" src="" alt="" style="display: none;">
                <label class="avatar-upload" for="avatarInput">üì∑ Change</label>
              </div>
              <div class="dropdown-user-info">
                <h4 id="dropdownUserName">Admin User</h4>
                <p id="dropdownUserPhone">Admin Account</p>
              </div>
            </div>
            
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" onclick="openSettings(); return false;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Settings
              </a>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item danger" onclick="logout()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Sign Out
              </button>
            </div>
          </div>
        </div>
        
        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarUpload(event)">
      </div>
    </div>
  </nav>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h3>Settings</h3>
        <button class="settings-close" onclick="closeSettings()">‚úï</button>
      </div>
      <div class="settings-body">
        <div class="settings-avatar-section">
          <div class="settings-avatar" id="settingsAvatar">
            <span id="settingsAvatarInitials">A</span>
            <img id="settingsAvatarImg" src="" alt="" style="display: none;">
          </div>
          <div class="settings-avatar-actions">
            <button class="avatar-upload-btn" onclick="document.getElementById('avatarInput').click()">Upload Photo</button>
            <button class="avatar-remove-btn" onclick="removeAvatar()">Remove Photo</button>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>Profile Information</h4>
          <div class="settings-input-group">
            <label>Full Name</label>
            <input type="text" class="settings-input" id="settingsName" placeholder="Your name">
          </div>
          <div class="settings-input-group">
            <label>Phone Number</label>
            <input type="text" class="settings-input" id="settingsPhone" placeholder="+91 XXXXX XXXXX" disabled>
          </div>
        </div>
      </div>
      <div class="settings-footer">
        <button class="settings-cancel-btn" onclick="closeSettings()">Cancel</button>
        <button class="settings-save-btn" onclick="saveSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <div class="page-badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
          Admin Portal
        </div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-description">Manage applications, assistants, and bookings</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportCsv()">üì• Export Bookings</button>
        <button class="btn btn-secondary" onclick="exportFeedbackCsv()">üì• Export Feedback</button>
        <button class="btn btn-danger" onclick="clearDemoData()">üóëÔ∏è Clear Demo</button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Bookings</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="statPending">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">In Progress</div>
        <div class="stat-value" id="statInProgress">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value" id="statCompleted">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Verified Assistants</div>
        <div class="stat-value" id="statAssistants">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Jobs Done</div>
        <div class="stat-value" id="statJobsDone">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Ratings</div>
        <div class="stat-value" id="statRatingCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Rating</div>
        <div class="stat-value" id="statAvgRating">0.00</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="applications">
        üìã Applications
        <span class="tab-badge" id="pendingAppsBadge" style="display: none;">0</span>
      </button>
      <button class="tab" data-tab="assistants">üë∑ Assistants</button>
      <button class="tab" data-tab="bookings">üìÖ Bookings</button>
      <button class="tab" data-tab="feedback">‚≠ê Feedback</button>
      <button class="tab" data-tab="audit">üìú Audit Logs</button>
      <span style="flex:1"></span>
      <button id="adminEmergencyTestBtn" title="Emergency Chat" style="margin-left:16px; background:#ef4444; color:#fff; border:none; border-radius:50%; width:44px; height:44px; font-size:22px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.12); cursor:pointer; display:flex; align-items:center; justify-content:center;">
        üö®
      </button>
      <div id="emergencyChatPanel" style="display:none; position:absolute; right:0; top:56px; z-index:1002; width:340px; max-width:95vw; background:#fff; border-radius:18px; box-shadow:0 8px 32px rgba(0,0,0,0.22); overflow:hidden; border:2px solid #ef4444;">
        <div style="background:#ef4444; color:#fff; padding:12px 16px; font-size:17px; font-weight:700; display:flex; align-items:center; justify-content:space-between;">
          <span>üö® Emergency Chat</span>
          <button onclick="closeAdminChatPanel()" style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">‚úï</button>
        </div>
        <div id="adminChatList" style="height:180px; overflow-y:auto; padding:10px 10px 0 10px; background:#f9fafb;"></div>
        <div id="adminTypingIndicator" style="height:16px; color:#888; font-size:12px; padding-left:12px;"></div>
        <div style="display:flex; border-top:1px solid #eee;">
          <input id="adminChatInput" type="text" placeholder="Type a message..." style="flex:1; border:none; padding:10px; font-size:14px; outline:none; background:#fff;">
          <button onclick="sendAdminChatMessage()" style="background:#10b981; color:#fff; border:none; padding:0 14px; font-size:15px; font-weight:600; cursor:pointer;">Send</button>
        </div>
      </div>
      <script>
      document.getElementById('adminEmergencyTestBtn').onclick = function() {
        openAdminChatPanel('test-booking-demo');
      };
      </script>
    </div>

    <!-- Applications Tab -->
    <div class="tab-content active" id="tab-applications">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Assistant Applications</h2>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="appStatusFilter" class="form-select">
                <option value="">All</option>
                <option value="Pending" selected>Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>
            <button class="btn btn-secondary" onclick="loadApplications()">Refresh</button>
          </div>
        </div>
        <div id="applicationsList"></div>
      </div>
    </div>

    <!-- Assistants Tab -->
    <div class="tab-content" id="tab-assistants">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Verified Assistants</h2>
          <button class="btn btn-secondary" onclick="loadAssistants()">Refresh</button>
        </div>
        <div id="assistantsList"></div>
      </div>
    </div>

    <!-- Bookings Tab -->
    <div class="tab-content" id="tab-bookings">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">All Bookings</h2>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Station</label>
              <select id="filterStation" class="form-select">
                <option value="">All</option>
                <option value="SC">Secunderabad (SC)</option>
                <option value="KCG">Kacheguda (KCG)</option>
                <option value="HYB">Hyderabad Deccan (HYB)</option>
                <option value="KZJ">Kazipet (KZJ)</option>
                <option value="BZA">Vijayawada (BZA)</option>
                <option value="WL">Warangal (WL)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="filterStatus" class="form-select">
                <option value="">All</option>
                <option>Pending</option>
                <option>Searching</option>
                <option>Accepted</option>
                <option>In Progress</option>
                <option>Completed</option>
                <option>Rejected</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Passenger</label>
              <input type="text" id="filterPassenger" class="form-input" placeholder="Name...">
            </div>
            <button class="btn btn-secondary" onclick="loadBookings()">Refresh</button>
            <button class="btn btn-danger" style="margin-left:8px" onclick="clearBookings()">üóëÔ∏è Clear Bookings</button>
          </div>
        </div>
        <div id="allBookings"></div>
      </div>
    </div>

    <!-- Audit Tab -->
    <div class="tab-content" id="tab-audit">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Audit Logs</h2>
          <button class="btn btn-secondary" onclick="loadAuditLogs()">Refresh</button>
        </div>
        <div id="auditLogs"></div>
      </div>
    </div>

    <!-- Feedback Tab -->
    <div class="tab-content" id="tab-feedback">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Customer Feedback</h2>
          <button class="btn btn-secondary" onclick="loadFeedback()">Refresh</button>
        </div>

        
        <!-- Feedback Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); border: 1px solid rgba(245, 158, 11, 0.2);">
            <div class="stat-number" id="feedbackAvgAssistant" style="color: #f59e0b;">0.0</div>
            <div class="stat-label">Avg Assistant Rating</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2);">
            <div class="stat-number" id="feedbackAvgApp" style="color: #3b82f6;">0.0</div>
            <div class="stat-label">Avg App Rating</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.2);">
            <div class="stat-number" id="feedbackTotal" style="color: #10b981;">0</div>
            <div class="stat-label">Total Reviews</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(139, 92, 246, 0.2);">
            <div class="stat-number" id="feedbackRecommend" style="color: #8b5cf6;">0%</div>
            <div class="stat-label">Would Recommend</div>
          </div>
        </div>
        
        <div id="feedbackList" style="display: grid; gap: 16px;"></div>
      </div>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal-overlay" id="editBookingModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Booking</h3>
        <button class="modal-close" onclick="closeModal('editBookingModal')">‚úï</button>
      </div>
      <div class="form-group">
        <label class="form-label">Passenger Name</label>
        <input type="text" id="editBName" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Station</label>
        <input type="text" id="editBStation" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Train</label>
        <input type="text" id="editBTrain" class="form-input">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
        <div class="form-group">
          <label class="form-label">Coach</label>
          <input type="text" id="editBCoach" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Seat</label>
          <input type="text" id="editBSeat" class="form-input">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Services</label>
        <input type="text" id="editBServices" class="form-input" placeholder="Comma separated">
      </div>
      <div class="form-group">
        <label class="form-label">Price</label>
        <input type="number" id="editBPrice" class="form-input">
      </div>
      <input type="hidden" id="editBId">
      <button class="btn btn-dark" style="width: 100%;" onclick="saveBooking()">Save Changes</button>
    </div>
  </div>

  <!-- Document Preview Modal -->
  <div class="modal-overlay" id="docPreviewModal">
    <div class="modal" style="max-width: 90vw; max-height: 90vh; padding: var(--space-4);">
      <div class="modal-header">
        <h3 class="modal-title">Document Preview</h3>
        <button class="modal-close" onclick="closeModal('docPreviewModal')">‚úï</button>
      </div>
      <div id="docPreviewContent" style="text-align: center;"></div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // Always use authFetch for admin API requests
    window.RailCareAuth = window.RailCareAuth || {};
    // Force window.authFetch to always use local storage/session token
    window.authFetch = function(url, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      const token = localStorage.getItem('railcare_token') || sessionStorage.getItem('railcare_token');
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      return fetch(url, opts);
    };
  </script>
  <script>
    // ==================== THEME ====================
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
    }

    // ==================== AUTH ====================
    window.RailCareAuth?.enforceRole?.('admin');

    // ==================== USER PROFILE ====================
    let currentUser = null;
    let userAvatar = null;

    function getToken() {
      return localStorage.getItem('railcare_token');
    }

    async function checkAuth() {
      const token = getToken();
      console.log('[DEBUG][checkAuth] token:', token);
      console.log('[DEBUG][checkAuth] localStorage.railcare_token:', localStorage.getItem('railcare_token'));
      console.log('[DEBUG][checkAuth] sessionStorage.railcare_token:', sessionStorage.getItem('railcare_token'));
      if (!token) {
        console.log('[DEBUG][checkAuth] No token found, showing sign in button');
        showSignInButton();
        return;
      }
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expiry = payload.exp * 1000;
        console.log('[DEBUG][checkAuth] Token payload:', payload, 'Expiry:', expiry, 'Now:', Date.now());
        if (expiry < Date.now()) {
          console.log('[DEBUG][checkAuth] Token expired, removing and showing sign in');
          localStorage.removeItem('railcare_token');
          showSignInButton();
          return;
        }
        currentUser = { name: payload.name, phone: payload.phone || '', role: payload.role };
        userAvatar = localStorage.getItem('railcare_avatar');
        console.log('[DEBUG][checkAuth] Valid token, showing user profile:', currentUser);
        showUserProfile(currentUser);
      } catch (e) {
        console.log('[DEBUG][checkAuth] Error parsing token:', e);
        showSignInButton();
      }
    }

    function showSignInButton() {
      document.getElementById('signInBtn')?.classList.remove('hidden');
      document.getElementById('profileSection')?.classList.remove('active');
    }

    function showUserProfile(user) {
      document.getElementById('signInBtn')?.classList.add('hidden');
      document.getElementById('profileSection')?.classList.add('active');

      const name = user.name || 'Admin';
      const initials = getInitials(name);

      const navUserName = document.getElementById('navUserName');
      if (navUserName) navUserName.textContent = name.split(' ')[0];
      
      const navAvatarInitials = document.getElementById('navAvatarInitials');
      if (navAvatarInitials) navAvatarInitials.textContent = initials;
      
      const dropdownUserName = document.getElementById('dropdownUserName');
      if (dropdownUserName) dropdownUserName.textContent = name;
      
      const dropdownUserPhone = document.getElementById('dropdownUserPhone');
      if (dropdownUserPhone) dropdownUserPhone.textContent = user.phone ? user.phone : 'Phone not set';
      
      const dropdownAvatarInitials = document.getElementById('dropdownAvatarInitials');
      if (dropdownAvatarInitials) dropdownAvatarInitials.textContent = initials;
      
      const settingsAvatarInitials = document.getElementById('settingsAvatarInitials');
      if (settingsAvatarInitials) settingsAvatarInitials.textContent = initials;
      
      const settingsName = document.getElementById('settingsName');
      if (settingsName) settingsName.value = name;
      
      const settingsPhone = document.getElementById('settingsPhone');
      if (settingsPhone) settingsPhone.value = user.phone || '';

      if (userAvatar) {
        updateAvatarImages(userAvatar);
      }
    }

    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function updateAvatarImages(src) {
      const avatarImgs = ['navAvatarImg', 'dropdownAvatarImg', 'settingsAvatarImg'];
      const avatarInitials = ['navAvatarInitials', 'dropdownAvatarInitials', 'settingsAvatarInitials'];
      
      avatarImgs.forEach((id, i) => {
        const img = document.getElementById(id);
        const initials = document.getElementById(avatarInitials[i]);
        if (src) {
          img.src = src;
          img.style.display = 'block';
          initials.style.display = 'none';
        } else {
          img.style.display = 'none';
          initials.style.display = 'block';
        }
      });
    }

    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      const trigger = document.querySelector('.profile-trigger');
      dropdown.classList.toggle('show');
      trigger.classList.toggle('open');
    }

    document.addEventListener('click', (e) => {
      const profileSection = document.getElementById('profileSection');
      if (profileSection && !profileSection.contains(e.target)) {
        document.getElementById('profileDropdown')?.classList.remove('show');
        document.querySelector('.profile-trigger')?.classList.remove('open');
      }
    });

    function openSettings() {
      document.getElementById('settingsModal').classList.add('show');
      document.getElementById('profileDropdown').classList.remove('show');
      document.querySelector('.profile-trigger')?.classList.remove('open');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        showToast('Image too large. Max 2MB allowed.');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        userAvatar = e.target.result;
        localStorage.setItem('railcare_avatar', userAvatar);
        updateAvatarImages(userAvatar);
        showToast('Profile photo updated!');
      };
      reader.readAsDataURL(file);
    }

    function removeAvatar() {
      userAvatar = null;
      localStorage.removeItem('railcare_avatar');
      updateAvatarImages(null);
      showToast('Profile photo removed');
    }

    function saveSettings() {
      const name = document.getElementById('settingsName').value.trim();
      if (!name) {
        showToast('Name is required');
        return;
      }
      currentUser.name = name;
      showUserProfile(currentUser);
      closeSettings();
      showToast('Settings saved!');
    }

    function logout() {
      localStorage.removeItem('railcare_token');
      localStorage.removeItem('railcare_avatar');
      currentUser = null;
      userAvatar = null;
      showSignInButton();
      document.getElementById('profileDropdown').classList.remove('show');
      showToast('Signed out successfully');
      setTimeout(() => { window.location.href = 'login-premium.html'; }, 1000);
    }

    // Robustly check auth and show profile after login
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAuth);
    } else {
      checkAuth();
    }
    // Also ensure profile is shown after login
    document.addEventListener('DOMContentLoaded', checkAuth);

    // ==================== MODALS ====================
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });

    // ==================== TABS ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab)?.classList.add('active');
        
        if (tab.dataset.tab === 'applications') loadApplications();
        else if (tab.dataset.tab === 'assistants') loadAssistants();
        else if (tab.dataset.tab === 'bookings') loadBookings();
        else if (tab.dataset.tab === 'feedback') loadFeedback();
        else if (tab.dataset.tab === 'audit') loadAuditLogs();
      });
    });

    // ==================== OVERVIEW STATS ====================
    async function loadOverview() {
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        // Always use authFetch to include Authorization header
        const res = await window.RailCareAuth.authFetch('/api/admin/stats');
        const data = await res.json();
        if (data.success && data.stats) {
          const stats = data.stats;
          // Bookings
          document.getElementById('statTotal').textContent = stats.bookings?.total || 0;
          document.getElementById('statPending').textContent = stats.bookings?.pending || 0;
          document.getElementById('statInProgress').textContent = stats.bookings?.inProgress || 0;
          document.getElementById('statCompleted').textContent = stats.bookings?.completed || 0;
          // Assistants
          document.getElementById('statAssistants').textContent = stats.assistants?.verified || 0;
          // Jobs Done, Ratings, Avg Rating (if present in stats)
          if (document.getElementById('statJobsDone')) {
            document.getElementById('statJobsDone').textContent = stats.jobsDone || 0;
          }
          if (document.getElementById('statRatingCount')) {
            document.getElementById('statRatingCount').textContent = stats.ratingCount || 0;
          }
          if (document.getElementById('statAvgRating')) {
            document.getElementById('statAvgRating').textContent = stats.avgRating || '0.00';
          }
        }
      } catch (e) {}
    }

    // ==================== APPLICATIONS ====================
    async function loadApplications() {
      const container = document.getElementById('applicationsList');
      container.innerHTML = '<div class="loading"></div>';
      
      try {
        const status = document.getElementById('appStatusFilter')?.value || '';
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/admin/applications${status ? '?status=' + status : ''}`);
        const data = await res.json();
        
        if (!data.success) {
          container.innerHTML = '<div class="empty-state"><p>Error loading applications</p></div>';
          return;
        }

        const apps = data.applications || [];
        
        // Update badge
        const pendingCount = apps.filter(a => a.applicationStatus === 'Pending').length;
        const badge = document.getElementById('pendingAppsBadge');
        if (badge) {
          badge.textContent = pendingCount;
          badge.style.display = pendingCount > 0 ? 'inline' : 'none';
        }

        if (apps.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No applications found</p></div>';
          return;
        }

        container.innerHTML = apps.map(app => {
          const statusClass = app.applicationStatus === 'Approved' ? 'status-approved' : 
                             app.applicationStatus === 'Rejected' ? 'status-rejected' : 'status-pending';
          
          const photoHtml = app.photoFilePath ? 
            `<img src="${app.photoFilePath}" alt="Photo">` : 'üë§';

          let actionsHtml = '';
          if (app.applicationStatus === 'Pending') {
            actionsHtml = `
              <button class="btn btn-success" onclick="approveApplication('${app._id}')">‚úì Approve</button>
              <button class="btn btn-danger" onclick="rejectApplication('${app._id}')">‚úï Reject</button>
            `;
          } else if (app.applicationStatus === 'Approved') {
            actionsHtml = '<span style="color: var(--emerald); font-weight: 600;">‚úì Approved</span>';
          } else {
            actionsHtml = `
              <span style="color: var(--ruby);">Rejected: ${app.rejectionReason || 'N/A'}</span>
              <button class="btn btn-success btn-sm" onclick="approveApplication('${app._id}')">Approve Now</button>
            `;
          }

          return `
            <div class="app-card">
              <div class="app-header">
                <div class="app-user">
                  <div class="app-avatar">${photoHtml}</div>
                  <div>
                    <div class="app-name">${app.name || 'Unknown'}</div>
                    <div class="app-station">${app.station || 'No station'}</div>
                  </div>
                </div>
                <span class="app-status ${statusClass}">${app.applicationStatus}</span>
              </div>
              <div class="app-details">
                <div>
                  <div class="app-detail-label">Phone</div>
                  <div class="app-detail-value">${app.phone || '-'}</div>
                </div>
                <div>
                  <div class="app-detail-label">Age</div>
                  <div class="app-detail-value">${app.age || '-'}</div>
                </div>
                <div>
                  <div class="app-detail-label">Experience</div>
                  <div class="app-detail-value">${app.yearsOfExperience || 0} years</div>
                </div>
                <div>
                  <div class="app-detail-label">Languages</div>
                  <div class="app-detail-value">${app.languages?.join(', ') || '-'}</div>
                </div>
              </div>
              <div class="app-docs">
                ${app.aadharFilePath ? `<a href="${app.aadharFilePath}" target="_blank" class="doc-link" onclick="event.preventDefault(); previewDoc('${app.aadharFilePath}')">ü™™ Aadhaar</a>` : '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">No Aadhaar</span>'}
                ${app.panFilePath ? `<a href="${app.panFilePath}" target="_blank" class="doc-link" onclick="event.preventDefault(); previewDoc('${app.panFilePath}')">üí≥ PAN</a>` : '<span style="color: var(--text-tertiary); font-size: var(--text-xs);">No PAN</span>'}
                ${app.photoFilePath ? `<a href="${app.photoFilePath}" target="_blank" class="doc-link" onclick="event.preventDefault(); previewDoc('${app.photoFilePath}')">üì∑ Photo</a>` : ''}
              </div>
              <div class="app-actions">${actionsHtml}</div>
            </div>
          `;
        }).join('');

      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--ruby);">Error: ${err.message}</p></div>`;
      }
    }

    async function approveApplication(id) {
      if (!confirm('Approve this application?')) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/admin/applications/${id}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          loadApplications();
          loadOverview();
        } else {
          alert('Error: ' + (data.message || 'Failed'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function rejectApplication(id) {
      const reason = prompt('Rejection reason:', 'Documents need clarification');
      if (!reason) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/admin/applications/${id}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason, allowReapply: true })
        });
        const data = await res.json();
        if (data.success) {
          loadApplications();
        } else {
          alert('Error: ' + (data.message || 'Failed'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ==================== ASSISTANTS ====================
    async function loadAssistants() {
      const container = document.getElementById('assistantsList');
      container.innerHTML = '<div class="loading"></div>';
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher('/api/assistants');
        const list = await res.json();
        
        // Flexible station matching: case-insensitive, trimmed
        const filterStation = (document.getElementById('filterStation')?.value || '').trim().toLowerCase();
        const approved = list.filter(a => {
          if ((a.applicationStatus !== 'Approved' && !a.verified) || a.revoked) return false;
          if (!filterStation || filterStation === '') return true;
          return (a.station || '').trim().toLowerCase() === filterStation;
        });
        const revoked = list.filter(a => a.revoked);
        let html = '';
        if (approved.length > 0) {
          html += '<h3 style="margin-bottom:12px;">Verified Assistants</h3>';
          html += approved.map(a => {
            const ratingText = a.rating ? `${a.rating.toFixed(1)} ‚òÖ (${a.ratingCount || 0})` : 'No ratings';
            return `
              <div class="app-card">
                <div class="app-header">
                  <div class="app-user">
                    <div class="app-avatar">${a.photoFilePath ? `<img src="${a.photoFilePath}">` : 'üë∑'}</div>
                    <div>
                      <div class="app-name">${a.name}</div>
                      <div class="app-station">${a.station} ‚Ä¢ ${a.languages?.join(', ') || '-'}</div>
                    </div>
                  </div>
                  <span class="app-status status-approved">Verified</span>
                </div>
                <div class="app-details">
                  <div>
                    <div class="app-detail-label">Rating</div>
                    <div class="app-detail-value">${ratingText}</div>
                  </div>
                  <div>
                    <div class="app-detail-label">Documents</div>
                    <div class="app-detail-value">${a.documentsVerified ? '‚úì Verified' : 'Pending'}</div>
                  </div>
                </div>
                <div class="app-actions">
                  <button class="btn btn-secondary btn-sm" onclick="editAssistant('${a._id}')">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="revokeAssistant('${a._id}')">Revoke</button>
                  <button class="btn btn-danger btn-sm" onclick="removeAssistant('${a._id}')">Remove</button>
                </div>
              </div>
            `;
          }).join('');
        }
        if (revoked.length > 0) {
          html += '<h3 style="margin:24px 0 12px 0;color:#d00;">Revoked Assistants</h3>';
          html += revoked.map(a => {
            const ratingText = a.rating ? `${a.rating.toFixed(1)} ‚òÖ (${a.ratingCount || 0})` : 'No ratings';
            const reverifyBadge = a.requestedReverify ? `<span style="background:#ffe5b4;color:#b45309;padding:2px 8px;border-radius:12px;font-size:12px;margin-left:8px;">Re-verify Requested</span>` : '';
            return `
              <div class="app-card" style="opacity:0.7;">
                <div class="app-header">
                  <div class="app-user">
                    <div class="app-avatar">${a.photoFilePath ? `<img src=\"http://localhost:3000/api/assistants/${a._id}/photo\"` : 'üë∑'}</div>
                    <div>
                      <div class="app-name">${a.name} ${reverifyBadge}</div>
                      <div class="app-station">${a.station} ‚Ä¢ ${a.languages?.join(', ') || '-'}</div>
                    </div>
                  </div>
                  <span class="app-status status-rejected">Revoked</span>
                </div>
                <div class="app-details">
                  <div>
                    <div class="app-detail-label">Rating</div>
                    <div class="app-detail-value">${ratingText}</div>
                  </div>
                  <div>
                    <div class="app-detail-label">Documents</div>
                    <div class="app-detail-value">${a.documentsVerified ? '‚úì Verified' : 'Pending'}</div>
                  </div>
                </div>
                <div class="app-actions">
                  <button class="btn btn-secondary btn-sm" onclick="editAssistant('${a._id}')">Edit</button>
                  <button class="btn btn-success btn-sm" onclick="verifyAgainAssistant('${a._id}')">Get Verified Again</button>
                  <button class="btn btn-danger btn-sm" onclick="removeAssistant('${a._id}')">Remove</button>
                </div>
              </div>
            `;
          }).join('');
        }
        if (!html) {
          html = '<div class="empty-state"><p>No verified or revoked assistants</p></div>';
        }
        container.innerHTML = html;
        // Admin: Get Verified Again for revoked assistant
        window.verifyAgainAssistant = async function(id) {
          if (!confirm('Re-verify this assistant and allow them to be assigned again?')) return;
          try {
            const fetcher = window.RailCareAuth?.authFetch || fetch;
            const res = await fetcher(`/api/assistants/${id}/verify-again`, { method: 'POST' });
            loadAssistants();
            loadOverview && loadOverview();
            if (res.ok) {
              showToast && showToast('Assistant is now eligible for bookings again.');
            } else {
              alert('Failed to re-verify assistant.');
            }
          } catch (e) { alert(e.message); }
        }
    // Remove assistant function
    window.removeAssistant = async function(id) {
      if (!confirm('Are you sure you want to permanently remove this assistant? This cannot be undone.')) return;
      try {
        const token = localStorage.getItem('railcare_token');
        const res = await fetch(`/api/admin/assistants/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          const text = await res.text();
          alert('Server error: ' + text.substring(0, 200));
          return;
        }
        if (data.success) {
          // If the removed assistant is the current user, log out and redirect
          const currentUser = await window.RailCareAuth?.getCurrentUser?.();
          if (currentUser && currentUser._id === id) {
            window.RailCareAuth?.setToken('');
            window.location.href = 'login-premium.html';
            return;
          }
          loadAssistants();
          loadOverview && loadOverview();
        } else {
          alert('Failed to remove assistant: ' + (data.message || 'Unknown error'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--ruby);">Error: ${err.message}</p></div>`;
      }
    }

    async function editAssistant(id) {
      const name = prompt('New name:');
      if (!name) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        await fetcher(`/api/assistants/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        loadAssistants();
      } catch (e) { alert(e.message); }
    }

    async function revokeAssistant(id) {
      if (!confirm('Revoke this assistant?')) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        await fetcher(`/api/assistants/${id}/reject`, { method: 'POST' });
        loadAssistants();
        loadOverview();
      } catch (e) { alert(e.message); }
    }

    // ==================== BOOKINGS ====================
    let _currentBookings = [];
    
    // Helper function to render luggage display (avoids nested template literals)
    function renderLuggageDisplay(b) {
      const luggageWeightInfo = { small: '‚â§5kg', medium: '‚â§10kg', large: '>10kg' };
      const luggageIcons = { small: 'üéí', medium: 'üß≥', large: 'üì¶' };
      
      // Check for new luggageItems array first
      if (b.luggageItems && b.luggageItems.length > 0) {
        const totalCost = b.totalLuggageCost || b.luggageItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
        let html = '<div style="padding: 12px; background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; margin-bottom: 12px;">';
        html += '<div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px;">üì¶ Luggage Summary</div>';
        html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">';
        b.luggageItems.forEach(item => {
          const icon = luggageIcons[item.type] || 'üì¶';
          const typeName = item.type.charAt(0).toUpperCase() + item.type.slice(1);
          const weight = luggageWeightInfo[item.type] || '';
          const price = item.totalPrice || (item.pricePerUnit * item.quantity);
          html += '<div style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px;">';
          html += '<span>' + icon + '</span>';
          html += '<span style="font-weight: 600; color: var(--amber);">' + typeName + ' √ó' + item.quantity + '</span>';
          html += '<span style="font-size: 10px; color: var(--text-tertiary);">(' + weight + ')</span>';
          html += '<span style="font-size: 11px; color: var(--text-secondary);">‚Çπ' + price + '</span>';
          html += '</div>';
        });
        html += '</div>';
        html += '<div style="font-size: 13px; font-weight: 600; color: var(--amber);">Total Luggage Cost: ‚Çπ' + totalCost + '</div>';
        html += '</div>';
        return html;
      }
      // Fallback to legacy single luggage
      else if (b.luggageSize && b.luggageSize !== 'none' && b.luggageQuantity > 0) {
        const icon = luggageIcons[b.luggageSize] || 'üì¶';
        const typeName = b.luggageSize.charAt(0).toUpperCase() + b.luggageSize.slice(1);
        const weight = luggageWeightInfo[b.luggageSize] || '';
        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 8px; margin-bottom: 12px; font-size: 13px;">';
        html += '<div><span style="color: var(--text-tertiary); font-size: 11px;">' + icon + ' Luggage Size</span>';
        html += '<div style="font-weight: 600; color: var(--amber);">' + typeName + ' (' + weight + ')</div></div>';
        html += '<div><span style="color: var(--text-tertiary); font-size: 11px;">üî¢ Quantity</span>';
        html += '<div style="font-weight: 600; color: var(--amber);">' + b.luggageQuantity + ' items</div></div>';
        html += '<div><span style="color: var(--text-tertiary); font-size: 11px;">üíµ Luggage Cost</span>';
        html += '<div style="font-weight: 600; color: var(--amber);">‚Çπ' + (b.luggageCost || 0) + '</div></div>';
        html += '</div>';
        return html;
      }
      return '';
    }

    async function loadBookings() {

      const container = document.getElementById('allBookings');
      container.innerHTML = '<div class="loading"></div>';
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        // Admin endpoint does not support filters yet
        const res = await fetcher('/api/admin/bookings');
        const data = await res.json();
        const list = data.bookings || [];
        const seen = new Map();
        (Array.isArray(list) ? list : []).forEach(b => {
          if (b && b._id && !seen.has(b._id)) seen.set(b._id, b);
        });
        _currentBookings = Array.from(seen.values());

        if (_currentBookings.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No bookings found</p></div>';
          return;
        }

        container.innerHTML = _currentBookings.map(b => {
          const statusClass = {
            'Pending': 'status-pending',
            'Searching': 'status-pending',
            'Accepted': 'status-approved',
            'Start Pending': 'status-approved',
            'In Progress': 'status-approved',
            'Completion Pending': 'status-approved',
            'Completed': 'status-approved',
            'Rejected': 'status-rejected',
            'Cancelled': 'status-rejected'
          }[b.status] || 'status-pending';
          
          const createdDate = b.createdAt ? new Date(b.createdAt).toLocaleDateString('en-IN', { 
            day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
          }) : '‚Äî';
          
          const assistantName = b.assistantId?.name || 'Not Assigned';

          return `
            <div class="booking-item" style="display: block; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                  <div class="booking-passenger" style="font-size: 16px; font-weight: 600;">${b.passengerName || 'Unknown'}</div>
                  <div class="booking-meta" style="font-size: 12px; color: var(--text-tertiary);">Created: ${createdDate}</div>
                </div>
                <span class="app-status ${statusClass}">${b.status}</span>
              </div>
              
              <!-- Contact Details -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üìû Phone</span>
                  <div style="font-weight: 500;">${b.passengerPhone || b.phone || '‚Äî'}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üìß Email</span>
                  <div style="font-weight: 500;">${b.passengerEmail || '‚Äî'}</div>
                </div>
              </div>
              
              <!-- Journey Details -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üöâ Station</span>
                  <div style="font-weight: 500;">${b.station || '‚Äî'}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üöÇ Train</span>
                  <div style="font-weight: 500;">${b.trainName || b.trainNumber || '‚Äî'}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üöÉ Coach</span>
                  <div style="font-weight: 500;">${b.coach || '‚Äî'}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üí∫ Seat</span>
                  <div style="font-weight: 500;">${b.seat || '‚Äî'}</div>
                </div>
              </div>
              
              <!-- Service Type & Direction -->
              ${b.serviceType ? `
              <div style="padding: 10px 12px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <div>
                    <span style="font-size: 11px; color: var(--text-tertiary);">üéØ Service Type</span>
                    <div style="font-weight: 600; font-size: 14px; color: var(--indigo);">
                      ${b.serviceType === 'pickup' ? 'Boarding Assistance' : b.serviceType === 'drop' ? 'Arrival Assistance' : 'Round Trip'}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <span style="font-size: 11px; color: var(--text-tertiary);">Direction</span>
                    <div style="font-weight: 500; font-size: 13px;">
                      ${b.serviceType === 'pickup' ? 'Platform ‚Üí Train' : b.serviceType === 'drop' ? 'Train ‚Üí Platform' : 'Platform ‚Üí Train ‚Üí Platform'}
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Services & Assistant -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üõéÔ∏è Services</span>
                  <div style="font-weight: 500;">${b.services?.join(', ') || '‚Äî'}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üë§ Assistant</span>
                  <div style="font-weight: 500;">${assistantName}</div>
                </div>
                <div>
                  <span style="color: var(--text-tertiary); font-size: 11px;">üí∞ Price</span>
                  <div style="font-weight: 500;">‚Çπ${b.price || 0}</div>
                </div>
              </div>
              
              ${renderLuggageDisplay(b)}
              
              ${b.passengerNotes ? `
              <div style="padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: var(--sapphire);">
                <strong>üìù Notes:</strong> ${b.passengerNotes}
              </div>
              ` : ''}
              
              ${b.language || (b.preferredLanguages && b.preferredLanguages.length > 0) ? `
              <div style="padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: var(--emerald);">
                <strong>üåê Language:</strong> ${b.preferredLanguages?.join(', ') || b.language || '‚Äî'}
              </div>
              ` : ''}
              
              <!-- DISTRIBUTED TASK ASSIGNMENT (for round_trip) -->
              ${b.serviceType === 'round_trip' ? `
              <div id="taskAssignment-${b._id}" style="border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(99, 102, 241, 0.05));">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                  <span style="font-size: 18px;">üîÑ</span>
                  <div>
                    <div style="font-weight: 700; font-size: 14px; color: var(--purple);">DISTRIBUTED TASK ASSIGNMENT</div>
                    <div style="font-size: 11px; color: var(--text-tertiary);">Assign different assistants to pickup and drop tasks</div>
                  </div>
                </div>
                <div id="tasksList-${b._id}" data-booking-id="${b._id}" class="round-trip-tasks" style="display: flex; flex-direction: column; gap: 10px;">
                  <div style="text-align: center; padding: 12px; color: var(--text-tertiary); font-size: 12px;">
                    <span class="loading" style="width: 16px; height: 16px; margin-right: 8px;"></span>
                    Loading tasks...
                  </div>
                </div>
              </div>
              ` : ''}
              
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${(b.status !== 'Completed' && b.status !== 'Cancelled' && b.status !== 'Rejected') ? `<button class="btn btn-secondary btn-sm" onclick="showEditBooking('${b._id}')">Edit</button>` : ''}
                <button class="btn btn-info btn-sm" style="background:#3b82f6;color:#fff; position:relative;" onclick="openAdminChatPanel('${b._id}', '${b.passengerName || ''}')">üí¨ Chat
                  <span id="chatBadge-${b._id}" style="display:none; position:absolute; top:-8px; right:-8px; background:#ef4444; color:#fff; border-radius:50%; font-size:12px; font-weight:700; padding:2px 7px; z-index:10;">0</span>
                </button>
                ${(b.status !== 'Completed' && b.status !== 'Cancelled' && b.status !== 'Rejected') ? `
                  ${b.serviceType !== 'round_trip' && !b.assistantId && (b.status === 'Pending' || b.status === 'Searching') ? `<button class="btn btn-success btn-sm" onclick="showAssignUI('${b._id}')">Assign</button>` : ''}
                  <button class="btn btn-danger btn-sm" onclick="cancelBooking('${b._id}')">Cancel</button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');

        // After rendering: load distributed tasks for round-trip bookings
        _currentBookings
          .filter(b => b && b._id && b.serviceType === 'round_trip')
          .forEach(b => loadBookingTasks(b._id));

      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--ruby);">Error: ${err.message}</p></div>`;
      }
    }

    function showEditBooking(id) {
      const b = _currentBookings.find(x => x._id === id);
      if (!b) return;
      
      document.getElementById('editBId').value = b._id;
      document.getElementById('editBName').value = b.passengerName || '';
      document.getElementById('editBStation').value = b.station || '';
      document.getElementById('editBTrain').value = b.trainName || '';
      document.getElementById('editBCoach').value = b.coach || '';
      document.getElementById('editBSeat').value = b.seat || '';
      document.getElementById('editBServices').value = (b.services || []).join(', ');
      document.getElementById('editBPrice').value = b.price || '';
      
      document.getElementById('editBookingModal').classList.add('active');
    }

    async function saveBooking() {
      const id = document.getElementById('editBId').value;
      const payload = {
        passengerName: document.getElementById('editBName').value.trim(),
        station: document.getElementById('editBStation').value.trim(),
        trainName: document.getElementById('editBTrain').value.trim(),
        coach: document.getElementById('editBCoach').value.trim(),
        seat: document.getElementById('editBSeat').value.trim(),
        services: document.getElementById('editBServices').value.split(',').map(s => s.trim()).filter(Boolean),
        price: parseFloat(document.getElementById('editBPrice').value) || 0
      };
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/bookings/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (j.success) {
          closeModal('editBookingModal');
          loadBookings();
        } else {
          alert('Failed: ' + (j.message || JSON.stringify(j)));
        }
      } catch (err) {
        alert(err.message);
      }
    }

    async function cancelBooking(id) {
      if (!confirm('Cancel this booking?')) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/bookings/${id}/cancel`, { method: 'POST' });
        const j = await res.json();
        if (j.success) {
          loadBookings();
          loadOverview();
        } else {
          alert('Failed: ' + (j.message || JSON.stringify(j)));
        }
      } catch (err) {
        alert(err.message);
      }
    }

    // ==================== DISTRIBUTED TASK ASSIGNMENT ====================
    // For round-trip bookings: Each task (pickup/drop) can have different assistants
    
    async function loadBookingTasks(bookingId) {
      const container = document.getElementById(`tasksList-${bookingId}`);
      if (!container) return;
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/scheduling/booking/${bookingId}/tasks`);
        const data = await res.json();
        
        if (!data.success || !data.tasks || data.tasks.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 12px; color: var(--text-tertiary); font-size: 12px;">
              No service tasks found. They may not have been created yet.
            </div>
          `;
          return;
        }
        
        container.innerHTML = data.tasks.map(task => {
          const isPickup = task.taskType === 'pickup';
          const taskColor = isPickup ? 'var(--emerald)' : 'var(--sapphire)';
          const taskBg = isPickup ? 'rgba(16, 185, 129, 0.1)' : 'rgba(59, 130, 246, 0.1)';
          const taskBorder = isPickup ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.3)';
          const taskIcon = isPickup ? 'üöâ' : 'üö∂‚Äç‚ôÇÔ∏è';
          const taskLabel = isPickup ? 'PICKUP (Boarding)' : 'DROP (Arrival)';
          const direction = isPickup ? 'Platform ‚Üí Train' : 'Train ‚Üí Platform';
          
          const scheduledTime = task.scheduledTime 
            ? new Date(task.scheduledTime).toLocaleString('en-IN', { 
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
              })
            : '‚Äî';
          
          const statusColors = {
            'pending': '#f59e0b',
            'assigned': '#3b82f6',
            'in_progress': '#8b5cf6',
            'completed': '#10b981',
            'cancelled': '#ef4444'
          };
          
          const statusColor = statusColors[task.status] || '#666';
          const assistantColor = task.isAssigned ? taskColor : 'var(--amber)';
          const assistantName = task.assistant ? task.assistant.name : 'Not Assigned';
          
          let html = '<div style="background: ' + taskBg + '; border: 1px solid ' + taskBorder + '; border-radius: 10px; padding: 14px;">';
          html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">';
          html += '<div style="display: flex; align-items: center; gap: 8px;">';
          html += '<span style="font-size: 20px;">' + taskIcon + '</span>';
          html += '<div>';
          html += '<div style="font-weight: 700; font-size: 13px; color: ' + taskColor + ';">' + taskLabel + '</div>';
          html += '<div style="font-size: 11px; color: var(--text-secondary);">' + direction + '</div>';
          html += '</div></div>';
          html += '<span style="padding: 3px 10px; background: ' + statusColor + '20; color: ' + statusColor + '; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">' + task.status + '</span>';
          html += '</div>';
          
          html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-bottom: 10px;">';
          html += '<div><span style="color: var(--text-tertiary);">Station</span><div style="font-weight: 600;">' + task.stationCode + '</div></div>';
          html += '<div><span style="color: var(--text-tertiary);">Scheduled</span><div style="font-weight: 600;">' + scheduledTime + '</div></div>';
          html += '<div><span style="color: var(--text-tertiary);">Assistant</span><div style="font-weight: 600; color: ' + assistantColor + ';">' + assistantName + '</div></div>';
          html += '</div>';
          
          html += '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
          if (task.status === 'pending' || (task.status === 'assigned' && !task.isAssigned)) {
            html += '<button class="btn btn-success btn-sm" onclick="showTaskAssignUI(\'' + task.taskId + '\', \'' + task.stationCode + '\', \'' + task.taskType + '\')" style="font-size: 11px; padding: 4px 12px;">Assign Assistant</button>';
          }
          if (task.isAssigned && task.status !== 'completed' && task.status !== 'cancelled') {
            html += '<button class="btn btn-secondary btn-sm" onclick="unassignTask(\'' + task.taskId + '\')" style="font-size: 11px; padding: 4px 12px;">Unassign</button>';
          }
          html += '</div></div>';
          
          return html;
        }).join('');
        
      } catch (err) {
        container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--ruby); font-size: 12px;">Error loading tasks: ' + err.message + '</div>';
      }
    }
    
    async function showTaskAssignUI(taskId, stationCode, taskType) {
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        
        // Get available assistants for this task
        const res = await fetcher(`/api/scheduling/tasks/${taskId}/available-assistants`);
        const data = await res.json();
        
        if (!data.success) {
          alert('Error: ' + (data.errors?.join(', ') || 'Failed to load assistants'));
          return;
        }
        
        const available = data.assistants.filter(a => a.available);
        
        if (available.length === 0) {
          alert(`No available assistants at station ${stationCode}.\n\nAll assistants may be at capacity or offline.`);
          return;
        }
        
        const taskLabel = taskType === 'pickup' ? 'PICKUP (Boarding)' : 'DROP (Arrival)';
        const options = available.map((a, i) => 
          `${i + 1}. ${a.name} ${a.isOnline ? 'üü¢' : '‚ö™'} (‚òÖ${a.rating.toFixed(1)}, ${a.activeTaskCount} active)`
        ).join('\n');
        
        const selected = prompt(
          `Assign assistant for ${taskLabel} task at ${stationCode}:\n\n` +
          options + '\n\n' +
          'Enter number:'
        );
        
        const idx = parseInt(selected) - 1;
        if (isNaN(idx) || idx < 0 || idx >= available.length) return;
        
        const assistantId = available[idx].id;
        
        // Validate before assigning
        const validateRes = await fetcher(`/api/scheduling/tasks/${taskId}/validate-assignment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assistantId })
        });
        const validateData = await validateRes.json();
        
        if (!validateData.validation.valid) {
          alert('‚ùå Cannot assign:\n\n' + validateData.validation.errors.join('\n'));
          return;
        }
        
        if (validateData.validation.warnings.length > 0) {
          const proceed = confirm(
            '‚ö†Ô∏è Warnings:\n\n' + validateData.validation.warnings.join('\n') + 
            '\n\nProceed anyway?'
          );
          if (!proceed) return;
        }
        
        // Assign
        const assignRes = await fetcher(`/api/scheduling/tasks/${taskId}/assign`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assistantId })
        });
        const assignData = await assignRes.json();
        
        if (assignData.success) {
          loadBookings();
        } else {
          alert('Failed: ' + (assignData.message || JSON.stringify(assignData)));
        }
        
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    
    async function unassignTask(taskId) {
      if (!confirm('Unassign assistant from this task?')) return;
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher(`/api/scheduling/tasks/${taskId}/unassign`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: 'Admin unassignment' })
        });
        const data = await res.json();
        
        if (data.success) {
          loadBookings();
        } else {
          alert('Failed: ' + (data.message || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
    // ==================== END DISTRIBUTED TASK ASSIGNMENT ====================

    async function showAssignUI(bookingId) {
      const b = _currentBookings.find(x => x._id === bookingId);
      if (!b) return;
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const r = await fetcher('/api/assistants');
        const assistants = await r.json();
        const candidates = assistants.filter(a => a.station === b.station && a.verified);
        
        if (!candidates.length) {
          alert('No verified assistants for this station');
          return;
        }

        const selected = prompt('Select assistant:\n' + candidates.map((a, i) => `${i + 1}. ${a.name}`).join('\n') + '\n\nEnter number:');
        const idx = parseInt(selected) - 1;
        if (isNaN(idx) || idx < 0 || idx >= candidates.length) return;

        const res = await fetcher(`/api/bookings/${bookingId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assistantId: candidates[idx]._id })
        });
        const data = await res.json();
        if (data.success) {
          loadBookings();
        } else {
          alert('Failed: ' + (data.message || JSON.stringify(data)));
        }
      } catch (err) {
        alert(err.message);
      }
    }

    // ==================== FEEDBACK ====================
    async function loadFeedback() {
      const container = document.getElementById('feedbackList');
      container.innerHTML = '<div class="loading"></div>';
      try {
        // Always use authFetch to ensure Authorization header is sent
        const fetcher = window.authFetch || (window.RailCareAuth && window.RailCareAuth.authFetch) || fetch;
        const res = await fetcher('/api/feedback');
        const feedbacks = await res.json();



        if (!Array.isArray(feedbacks) || feedbacks.length === 0) {
          container.innerHTML += '<div class="empty-state"><p>No feedback received yet</p></div>';
          document.getElementById('feedbackAvgAssistant').textContent = '0.0';
          document.getElementById('feedbackAvgApp').textContent = '0.0';
          document.getElementById('feedbackTotal').textContent = '0';
          document.getElementById('feedbackRecommend').textContent = '0%';
          return;
        }

        // Calculate stats
        const totalFeedbacks = feedbacks.length;
        const avgAssistant = (feedbacks.reduce((sum, f) => sum + (f.assistantRating || f.rating || 0), 0) / totalFeedbacks).toFixed(1);
        const avgApp = (feedbacks.reduce((sum, f) => sum + (f.appRating || f.rating || 0), 0) / totalFeedbacks).toFixed(1);
        const recommendCount = feedbacks.filter(f => f.wouldRecommend === true).length;
        const recommendPercent = Math.round((recommendCount / totalFeedbacks) * 100);

        document.getElementById('feedbackAvgAssistant').textContent = avgAssistant;
        document.getElementById('feedbackAvgApp').textContent = avgApp;
        document.getElementById('feedbackTotal').textContent = totalFeedbacks;
        document.getElementById('feedbackRecommend').textContent = recommendPercent + '%';

        container.innerHTML += feedbacks.map(fb => {
          const assistantStars = '‚òÖ'.repeat(fb.assistantRating || fb.rating || 0) + '‚òÜ'.repeat(5 - (fb.assistantRating || fb.rating || 0));
          const appStars = '‚òÖ'.repeat(fb.appRating || fb.rating || 0) + '‚òÜ'.repeat(5 - (fb.appRating || fb.rating || 0));
          const date = new Date(fb.createdAt).toLocaleDateString('en-IN', { 
            day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          // Pre-compute the recommend badge HTML to avoid CSS linter issues with template literals in style attributes
          let recommendBadge = '';
          if (fb.wouldRecommend !== undefined) {
            const recommendBg = fb.wouldRecommend ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
            const recommendColor = fb.wouldRecommend ? '#10b981' : '#ef4444';
            const recommendText = fb.wouldRecommend ? 'üëç Would Recommend' : 'üëé Not Recommended';
            recommendBadge = '<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ' + recommendBg + '; color: ' + recommendColor + ';">' + recommendText + '</span>';
          }
          // Assistant behavior badge
          let behaviorBadge = '';
          if (fb.assistantBehavior) {
            let color = '#3b82f6';
            if (fb.assistantBehavior === 'Rude') color = '#ef4444';
            else if (fb.assistantBehavior === 'Perfect') color = '#10b981';
            else if (fb.assistantBehavior === 'Helpful') color = '#f59e0b';
            behaviorBadge = `<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(59,130,246,0.15); color: ${color}; margin-right: 8px;">${fb.assistantBehavior}</span>`;
          }
          return `
            <div style="background: var(--bg-secondary); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                <div>
                  <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                    ${fb.passengerName || 'Anonymous'}
                  </h4>
                  <p style="font-size: 13px; color: var(--text-tertiary);">
                    ${fb.station || 'Unknown Station'} ‚Ä¢ ${date}
                  </p>
                </div>
                <div style="text-align: right;">
                  ${recommendBadge}
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div>
                  <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Assistant: ${fb.assistantName || 'Unknown'}</div>
                  <div style="font-size: 20px; color: #f59e0b;">${assistantStars}</div>
                  ${behaviorBadge}
                </div>
                <div>
                  <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">App Rating</div>
                  <div style="font-size: 20px; color: #3b82f6;">${appStars}</div>
                </div>
              </div>
              ${fb.assistantFeedback || fb.appFeedback || fb.comments ? `
                <div style="background: var(--bg-primary); border-radius: 10px; padding: 14px; margin-top: 12px;">
                  <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 6px; font-weight: 600;">Feedback given by passenger:</div>
                  ${fb.assistantFeedback ? `
                    <div style="margin-bottom: 10px;">
                      <span style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">About Assistant:</span>
                      <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">"${fb.assistantFeedback}"</p>
                    </div>
                  ` : ''}
                  ${fb.appFeedback ? `
                    <div>
                      <span style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">About App:</span>
                      <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">"${fb.appFeedback}"</p>
                    </div>
                  ` : ''}
                  ${!fb.assistantFeedback && !fb.appFeedback && fb.comments ? `
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">"${fb.comments}"</p>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--ruby);">Error: ${err.message}</p></div>`;
      }
    }

    // ==================== AUDIT LOGS ====================
    async function loadAuditLogs() {
      const container = document.getElementById('auditLogs');
      container.innerHTML = '<div class="loading"></div>';
      
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher('/api/admin/audit');
        const j = await res.json();
        
        if (!j.success || !j.logs?.length) {
          container.innerHTML = '<div class="empty-state"><p>No audit logs</p></div>';
          return;
        }

        container.innerHTML = j.logs.map(l => `
          <div class="audit-item">
            <div class="audit-action">${l.action} ‚Äî ${l.targetType}</div>
            <div class="audit-meta">
              By: ${l.actorRole || 'System'} ‚Ä¢ ${new Date(l.createdAt).toLocaleString()}
            </div>
          </div>
        `).join('');

      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p style="color: var(--ruby);">Error: ${err.message}</p></div>`;
      }
    }

    // ==================== DOCUMENT PREVIEW ====================
    function previewDoc(url) {
      const ext = url.split('.').pop().toLowerCase();
      const content = document.getElementById('docPreviewContent');
      
      if (ext === 'pdf') {
        content.innerHTML = `<iframe src="${url}" style="width: 100%; height: 70vh; border: 0;"></iframe>`;
      } else {
        content.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: var(--radius-md);">`;
      }
      
      document.getElementById('docPreviewModal').classList.add('active');
    }

    // ==================== EXPORTS ====================
    function exportCsv() {
      if (!_currentBookings?.length) return alert('No bookings to export');
      const rows = [['ID', 'Passenger', 'Phone', 'Station', 'Train', 'Coach', 'Seat', 'Services', 'Luggage Size', 'Luggage Qty', 'Luggage Cost', 'Status', 'Price', 'Date']];
      _currentBookings.forEach(b => {
        const luggageDisplay = b.luggageSize && b.luggageSize !== 'none' ? b.luggageSize : 'None';
        rows.push([
          b._id, b.passengerName, b.phone, b.station, b.trainName,
          b.coach, b.seat, (b.services || []).join(';'), luggageDisplay, b.luggageQuantity || 0, b.luggageCost || 0, b.status, b.price, b.createdAt
        ].map(v => `"${(v || '').toString().replace(/"/g, '""')}"`));
      });
      downloadCsv(rows.map(r => r.join(',')).join('\n'), 'bookings');
    }

    async function exportFeedbackCsv() {
      try {
        const fetcher = window.authFetch || (window.RailCareAuth && window.RailCareAuth.authFetch) || fetch;
        const res = await fetcher('/api/feedback');
        const list = await res.json();
        if (!list?.length) return alert('No feedback');
        const rows = [['ID', 'Booking', 'Assistant', 'Rating', 'Comments', 'Date']];
        list.forEach(f => {
          rows.push([f._id, f.bookingId, f.assistantName, f.rating, f.comments, f.createdAt]
            .map(v => `"${(v || '').toString().replace(/"/g, '""')}"`));
        });
        downloadCsv(rows.map(r => r.join(',')).join('\n'), 'feedback');
      } catch (err) {
        alert('Export failed: ' + err.message);
      }
    }

    function downloadCsv(csv, name) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function clearDemoData() {
      if (!confirm('Clear all demo data?')) return;
      try {
        // Always use authFetch to ensure Authorization header is sent
        const fetcher = window.RailCareAuth?.authFetch || authFetch || fetch;
        await fetcher('/api/admin/clear-demo', { method: 'PATCH' });
        loadBookings();
        loadAssistants();
        loadOverview();
        loadApplications();
      } catch (err) {
        alert(err.message);
      }
    }

    // ==================== FILTERS ====================

    async function clearBookings() {
      if (!confirm('Clear all bookings? This cannot be undone.')) return;
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        await fetcher('/api/admin/clear-bookings', { method: 'POST' });
        loadBookings();
        loadOverview && loadOverview();
      } catch (err) {
        alert(err.message || 'Failed to clear bookings');
      }
    }
    document.getElementById('filterStation')?.addEventListener('change', loadBookings);
    document.getElementById('filterStatus')?.addEventListener('change', loadBookings);
    document.getElementById('filterPassenger')?.addEventListener('keyup', () => {
      clearTimeout(window._filterTimer);
      window._filterTimer = setTimeout(loadBookings, 400);
    });
    document.getElementById('appStatusFilter')?.addEventListener('change', loadApplications);

    // ==================== INIT ====================
    loadApplications();
    loadOverview();

    // Polling
    setInterval(() => {
      const activeTab = document.querySelector('.tab.active')?.dataset?.tab || 'applications';
      loadOverview();
      if (activeTab === 'applications') loadApplications();
      else if (activeTab === 'assistants') loadAssistants();
      else if (activeTab === 'bookings') loadBookings();
      else if (activeTab === 'feedback') loadFeedback();
      else if (activeTab === 'audit') loadAuditLogs();
    }, 15000);
  </script>

</body>
</html>
