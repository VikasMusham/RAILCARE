<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply as Assistant - RailMitra</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .application-container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50px;
      right: 50px;
      height: 4px;
      background: #e0e0e0;
      z-index: 0;
    }
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      flex: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
    }
    .step-circle.active {
      background: #007bff;
      color: white;
    }
    .step-circle.completed {
      background: #28a745;
      color: white;
    }
    .step-label {
      font-size: 12px;
      color: #666;
      text-align: center;
    }
    .form-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .form-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
    }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-row > div {
      flex: 1;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    .form-group label .required {
      color: #dc3545;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .language-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .language-tag {
      padding: 6px 12px;
      border-radius: 20px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }
    .language-tag:hover {
      border-color: #007bff;
    }
    .language-tag.selected {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .file-upload-box {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-upload-box:hover {
      border-color: #007bff;
      background: #f0f7ff;
    }
    .file-upload-box.has-file {
      border-color: #28a745;
      background: #f0fff4;
    }
    .file-upload-box input {
      display: none;
    }
    .file-upload-box .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .file-upload-box .filename {
      font-size: 12px;
      color: #28a745;
      margin-top: 8px;
    }
    .submit-section {
      text-align: center;
      padding: 20px;
    }
    .submit-btn {
      padding: 15px 50px;
      font-size: 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .submit-btn:hover {
      background: #0056b3;
    }
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .error-message {
      color: #dc3545;
      font-size: 13px;
      margin-top: 4px;
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .alert-info {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .photo-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">RailMitra <small>Station Assistance</small></div>
    <nav>
      <a href="index.html" class="ghost">Home</a>
      <span style="margin:0 8px;color:#ccc">‚Ä¢</span>
      <a href="login.html" class="ghost">Login</a>
    </nav>
  </header>

  <main class="main">
    <div class="application-container">
      <h1 style="text-align:center;margin-bottom:10px">üöÇ Become a RailMitra Assistant</h1>
      <p style="text-align:center;color:#666;margin-bottom:30px">Join our network of station assistants and help passengers across India</p>

      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-step">
          <div class="step-circle active">1</div>
          <div class="step-label">Apply</div>
        </div>
        <div class="progress-step">
          <div class="step-circle">2</div>
          <div class="step-label">Under Review</div>
        </div>
        <div class="progress-step">
          <div class="step-circle">3</div>
          <div class="step-label">Approved</div>
        </div>
      </div>

      <div id="alertBox"></div>

      <form id="applicationForm">
        <!-- Personal Information -->
        <div class="form-section">
          <h3>üë§ Personal Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Full Name <span class="required">*</span></label>
              <input type="text" id="fullName" required placeholder="Enter your full name" />
            </div>
            <div class="form-group">
              <label>Phone Number <span class="required">*</span></label>
              <input type="tel" id="phone" required placeholder="10-digit mobile number" pattern="[0-9]{10}" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Age <span class="required">*</span></label>
              <input type="number" id="age" required min="18" max="65" placeholder="Your age" />
            </div>
            <div class="form-group">
              <label>Years of Experience</label>
              <input type="number" id="experience" min="0" max="50" placeholder="Optional" />
            </div>
          </div>
          <div class="form-group">
            <label>Permanent Address <span class="required">*</span></label>
            <textarea id="address" required placeholder="Enter your complete permanent address"></textarea>
          </div>
        </div>

        <!-- Station & Languages -->
        <div class="form-section">
          <h3>üöâ Station & Skills</h3>
          <div class="form-group">
            <label>Select Station <span class="required">*</span></label>
            <select id="station" required>
              <option value="">-- Select your preferred station --</option>
              <option value="Secunderabad">Secunderabad</option>
              <option value="Kacheguda">Kacheguda</option>
              <option value="Hyderabad Deccan">Hyderabad Deccan</option>
              <option value="Kazipet">Kazipet</option>
              <option value="Vijayawada">Vijayawada</option>
              <option value="Warangal">Warangal</option>
              <option value="Tirupati">Tirupati</option>
              <option value="Visakhapatnam">Visakhapatnam</option>
              <option value="Chennai Central">Chennai Central</option>
              <option value="Mumbai CST">Mumbai CST</option>
              <option value="New Delhi">New Delhi</option>
              <option value="Howrah">Howrah</option>
              <option value="Bengaluru">Bengaluru</option>
            </select>
          </div>
          <div class="form-group">
            <label>Languages You Speak <span class="required">*</span></label>
            <p style="font-size:12px;color:#666;margin-bottom:8px">Select all languages you can communicate in</p>
            <div class="language-tags" id="languageTags">
              <span class="language-tag" data-lang="Telugu">Telugu</span>
              <span class="language-tag" data-lang="Hindi">Hindi</span>
              <span class="language-tag" data-lang="English">English</span>
              <span class="language-tag" data-lang="Tamil">Tamil</span>
              <span class="language-tag" data-lang="Kannada">Kannada</span>
              <span class="language-tag" data-lang="Malayalam">Malayalam</span>
              <span class="language-tag" data-lang="Marathi">Marathi</span>
              <span class="language-tag" data-lang="Bengali">Bengali</span>
              <span class="language-tag" data-lang="Gujarati">Gujarati</span>
              <span class="language-tag" data-lang="Punjabi">Punjabi</span>
              <span class="language-tag" data-lang="Odia">Odia</span>
              <span class="language-tag" data-lang="Urdu">Urdu</span>
            </div>
            <input type="hidden" id="selectedLanguages" />
          </div>
        </div>

        <!-- Document Upload -->
        <div class="form-section">
          <h3>üìÑ Document Verification</h3>
          <p style="font-size:13px;color:#666;margin-bottom:15px">Upload clear photos/scans of your documents. Accepted formats: JPG, PNG, PDF (Max 5MB each)</p>
          
          <div class="form-row">
            <div class="form-group">
              <label>Aadhaar Card <span class="required">*</span></label>
              <div class="file-upload-box" id="aadharBox">
                <div class="icon">ü™™</div>
                <div>Click to upload Aadhaar</div>
                <input type="file" id="aadharFile" accept=".jpg,.jpeg,.png,.pdf" required />
                <div class="filename" id="aadharFilename"></div>
              </div>
            </div>
            <div class="form-group">
              <label>PAN Card <span class="required">*</span></label>
              <div class="file-upload-box" id="panBox">
                <div class="icon">üí≥</div>
                <div>Click to upload PAN</div>
                <input type="file" id="panFile" accept=".jpg,.jpeg,.png,.pdf" required />
                <div class="filename" id="panFilename"></div>
              </div>
            </div>
          </div>
          
          <div class="form-group" style="max-width:300px">
            <label>Profile Photo <span class="required">*</span></label>
            <div class="file-upload-box" id="photoBox">
              <div class="icon">üì∑</div>
              <div>Click to upload photo</div>
              <input type="file" id="photoFile" accept=".jpg,.jpeg,.png" required />
              <div class="filename" id="photoFilename"></div>
            </div>
            <img id="photoPreview" class="photo-preview" alt="Preview" />
          </div>
        </div>

        <!-- Terms & Submit -->
        <div class="form-section">
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
              <input type="checkbox" id="termsCheck" required style="width:auto" />
              <span>I agree to the <a href="#" onclick="alert('Terms and conditions...')">Terms & Conditions</a> and certify that all information provided is accurate.</span>
            </label>
          </div>
        </div>

        <div class="submit-section">
          <button type="submit" class="submit-btn" id="submitBtn">
            üöÄ Submit Application
          </button>
          <p style="margin-top:10px;font-size:13px;color:#666">Your application will be reviewed within 24-48 hours</p>
        </div>
      </form>
    </div>
  </main>

  <script src="auth.js"></script>
  <script>
    // Check if user is logged in as assistant
    (async () => {
      await window.RailCareAuth?.enforceRole?.('assistant');
      
      // Check if already applied
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher('/api/assistants/my-application');
        const data = await res.json();
        
        if (data.success && data.assistant) {
          if (data.assistant.hasApplied) {
            // Already applied, redirect to status page
            window.location.href = 'assistant-status.html';
            return;
          }
          // Pre-fill form if partial data exists
          if (data.assistant.name) document.getElementById('fullName').value = data.assistant.name;
          if (data.assistant.phone) document.getElementById('phone').value = data.assistant.phone;
        }
      } catch (e) { /* Not applied yet, continue */ }
    })();

    // Language selection
    const languageTags = document.querySelectorAll('.language-tag');
    const selectedLanguages = new Set();
    
    languageTags.forEach(tag => {
      tag.addEventListener('click', () => {
        const lang = tag.dataset.lang;
        if (selectedLanguages.has(lang)) {
          selectedLanguages.delete(lang);
          tag.classList.remove('selected');
        } else {
          selectedLanguages.add(lang);
          tag.classList.add('selected');
        }
        document.getElementById('selectedLanguages').value = Array.from(selectedLanguages).join(',');
      });
    });

    // File upload boxes
    function setupFileUpload(boxId, inputId, filenameId, previewId = null) {
      const box = document.getElementById(boxId);
      const input = document.getElementById(inputId);
      const filename = document.getElementById(filenameId);
      const preview = previewId ? document.getElementById(previewId) : null;

      box.addEventListener('click', () => input.click());
      
      input.addEventListener('change', () => {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            input.value = '';
            return;
          }
          filename.textContent = '‚úì ' + file.name;
          box.classList.add('has-file');
          
          if (preview && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        }
      });
    }

    setupFileUpload('aadharBox', 'aadharFile', 'aadharFilename');
    setupFileUpload('panBox', 'panFile', 'panFilename');
    setupFileUpload('photoBox', 'photoFile', 'photoFilename', 'photoPreview');

    // Form submission
    document.getElementById('applicationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const alertBox = document.getElementById('alertBox');
      const submitBtn = document.getElementById('submitBtn');
      
      // Validate languages
      if (selectedLanguages.size === 0) {
        alertBox.innerHTML = '<div class="alert alert-danger">Please select at least one language</div>';
        return;
      }

      // Validate files
      const aadharFile = document.getElementById('aadharFile').files[0];
      const panFile = document.getElementById('panFile').files[0];
      const photoFile = document.getElementById('photoFile').files[0];

      if (!aadharFile || !panFile || !photoFile) {
        alertBox.innerHTML = '<div class="alert alert-danger">Please upload all required documents</div>';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Submitting...';
      alertBox.innerHTML = '';

      try {
        const formData = new FormData();
        formData.append('name', document.getElementById('fullName').value.trim());
        formData.append('phone', document.getElementById('phone').value.trim());
        formData.append('age', document.getElementById('age').value);
        formData.append('station', document.getElementById('station').value);
        formData.append('languages', document.getElementById('selectedLanguages').value);
        formData.append('permanentAddress', document.getElementById('address').value.trim());
        formData.append('yearsOfExperience', document.getElementById('experience').value || 0);
        formData.append('aadhar', aadharFile);
        formData.append('pan', panFile);
        formData.append('photo', photoFile);

        // Get token from correct localStorage key
        const token = localStorage.getItem('railcare_token');
        if (!token) {
          throw new Error('You must be logged in to apply. Please login first.');
        }
        
        const res = await fetch('/api/assistants/apply', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        const result = await res.json();

        if (!res.ok || !result.success) {
          throw new Error(result.message || 'Application failed');
        }

        // Success - redirect to status page
        alertBox.innerHTML = '<div class="alert alert-info">‚úÖ Application submitted successfully! Redirecting...</div>';
        setTimeout(() => {
          window.location.href = 'assistant-status.html';
        }, 1500);

      } catch (err) {
        console.error('Application error:', err);
        alertBox.innerHTML = `<div class="alert alert-danger">‚ùå ${err.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.textContent = 'üöÄ Submit Application';
      }
    });
  </script>
</body>
</html>
