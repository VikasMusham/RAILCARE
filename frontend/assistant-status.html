<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application Status - RailMitra</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .status-container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50px;
      right: 50px;
      height: 4px;
      background: #e0e0e0;
      z-index: 0;
    }
    .progress-bar.step-2::before {
      background: linear-gradient(to right, #28a745 0%, #28a745 50%, #e0e0e0 50%);
    }
    .progress-bar.step-3::before {
      background: #28a745;
    }
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      flex: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      transition: all 0.3s;
    }
    .step-circle.active {
      background: #007bff;
      color: white;
      animation: pulse 2s infinite;
    }
    .step-circle.completed {
      background: #28a745;
      color: white;
    }
    .step-circle.rejected {
      background: #dc3545;
      color: white;
    }
    .step-label {
      font-size: 12px;
      color: #666;
      text-align: center;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }
    .status-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .status-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status-message {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
    }
    .status-pending .status-icon { animation: bounce 1s infinite; }
    .status-pending .status-title { color: #856404; }
    .status-pending { background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); }
    
    .status-approved .status-icon { animation: none; }
    .status-approved .status-title { color: #155724; }
    .status-approved { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
    
    .status-rejected .status-title { color: #721c24; }
    .status-rejected { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .action-buttons {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #1e7e34;
    }
    .btn-warning {
      background: #ffc107;
      color: #333;
    }
    .btn-warning:hover {
      background: #e0a800;
    }
    .info-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
    }
    .info-section h3 {
      margin-top: 0;
      color: #333;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #666;
    }
    .info-value {
      font-weight: 600;
      color: #333;
    }
    .rejection-reason {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      text-align: left;
    }
    .rejection-reason h4 {
      margin: 0 0 10px 0;
      color: #721c24;
    }
    .rejection-reason p {
      margin: 0;
      color: #721c24;
    }
    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    .loading-spinner {
      font-size: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">RailMitra <small>Station Assistance</small></div>
    <nav>
      <a href="index.html" class="ghost">Home</a>
      <span style="margin:0 8px;color:#ccc">‚Ä¢</span>
      <a href="#" onclick="logout()" class="ghost">Logout</a>
    </nav>
  </header>

  <main class="main">
    <div class="status-container">
      <h1 style="text-align:center;margin-bottom:10px">üìã Application Status</h1>
      <p style="text-align:center;color:#666;margin-bottom:30px">Track your RailMitra Assistant application</p>

      <div id="loadingState" class="loading">
        <div class="loading-spinner">‚è≥</div>
        <p>Loading your application status...</p>
      </div>

      <div id="statusContent" style="display:none">
        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
          <div class="progress-step">
            <div class="step-circle completed" id="step1">‚úì</div>
            <div class="step-label">Applied</div>
          </div>
          <div class="progress-step">
            <div class="step-circle" id="step2">2</div>
            <div class="step-label">Under Review</div>
          </div>
          <div class="progress-step">
            <div class="step-circle" id="step3">3</div>
            <div class="step-label">Approved</div>
          </div>
        </div>

        <!-- Status Card -->
        <div class="status-card" id="statusCard">
          <div class="status-icon" id="statusIcon">‚è≥</div>
          <div class="status-title" id="statusTitle">Under Review</div>
          <div class="status-message" id="statusMessage">
            Your application is being reviewed by the RailMitra team.
          </div>
          <div id="rejectionReason" class="rejection-reason" style="display:none">
            <h4>‚ùå Rejection Reason</h4>
            <p id="rejectionText"></p>
          </div>
          <div class="action-buttons" id="actionButtons"></div>
        </div>

        <!-- Application Info -->
        <div class="info-section" id="appInfo">
          <h3>üìù Your Application Details</h3>
          <div id="appDetails"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="auth.js"></script>
  <script>
    let applicationData = null;

    function logout() {
      localStorage.removeItem('railcare_token');
      localStorage.removeItem('railcare_user');
      window.location.href = 'login.html';
    }

    async function loadApplicationStatus() {
      try {
        const fetcher = window.RailCareAuth?.authFetch || fetch;
        const res = await fetcher('/api/assistants/my-application');
        const data = await res.json();

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('statusContent').style.display = 'block';

        if (!data.success || !data.assistant) {
          // No application found, redirect to apply page
          window.location.href = 'assistant-apply.html';
          return;
        }

        applicationData = data.assistant;
        renderStatus(applicationData);

      } catch (err) {
        console.error('Error loading status:', err);
        document.getElementById('loadingState').innerHTML = `
          <div style="color:#dc3545">‚ùå Error loading application status</div>
          <p>${err.message}</p>
          <a href="login.html" class="btn btn-primary">Login Again</a>
        `;
      }
    }

    function renderStatus(assistant) {
      const progressBar = document.getElementById('progressBar');
      const statusCard = document.getElementById('statusCard');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const statusIcon = document.getElementById('statusIcon');
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');
      const actionButtons = document.getElementById('actionButtons');
      const rejectionReason = document.getElementById('rejectionReason');

      // Reset classes
      statusCard.className = 'status-card';
      step2.className = 'step-circle';
      step3.className = 'step-circle';
      progressBar.className = 'progress-bar';

      const status = assistant.applicationStatus;

      if (status === 'Pending') {
        progressBar.classList.add('step-2');
        step2.classList.add('active');
        step2.textContent = '‚è≥';
        statusCard.classList.add('status-pending');
        statusIcon.textContent = '‚è≥';
        statusTitle.textContent = 'Application Under Review';
        statusMessage.innerHTML = `
          Your application is currently being reviewed by the RailMitra Admin team.<br><br>
          <strong>Expected time:</strong> 24-48 hours<br>
          <small style="color:#856404">We'll notify you once a decision is made.</small>
        `;
        actionButtons.innerHTML = `
          <button class="btn btn-warning" onclick="window.location.reload()">üîÑ Refresh Status</button>
        `;
        rejectionReason.style.display = 'none';

      } else if (status === 'Approved') {
        progressBar.classList.add('step-3');
        step2.classList.add('completed');
        step2.textContent = '‚úì';
        step3.classList.add('completed');
        step3.textContent = '‚úì';
        statusCard.classList.add('status-approved');
        statusIcon.textContent = 'üéâ';
        statusTitle.textContent = 'Congratulations! You\'re Approved!';
        statusMessage.innerHTML = `
          Welcome to the RailMitra family! Your application has been approved.<br><br>
          You can now access the Assistant Dashboard and start helping passengers.
        `;
        actionButtons.innerHTML = `
          <a href="assistant.html" class="btn btn-success">üöÄ Go to Dashboard</a>
        `;
        rejectionReason.style.display = 'none';

      } else if (status === 'Rejected') {
        step2.classList.add('rejected');
        step2.textContent = '‚úó';
        statusCard.classList.add('status-rejected');
        statusIcon.textContent = 'üòî';
        statusTitle.textContent = 'Application Rejected';
        statusMessage.innerHTML = `
          Unfortunately, your application was not approved at this time.<br>
          Please review the feedback below and update your application.
        `;
        
        if (assistant.rejectionReason) {
          rejectionReason.style.display = 'block';
          document.getElementById('rejectionText').textContent = assistant.rejectionReason;
        }

        if (assistant.editableApplication) {
          actionButtons.innerHTML = `
            <a href="assistant-apply.html?edit=true" class="btn btn-primary">‚úèÔ∏è Edit & Reapply</a>
          `;
        } else {
          actionButtons.innerHTML = `
            <button class="btn btn-warning" disabled>Application cannot be edited</button>
          `;
        }

      } else {
        // Not Applied
        window.location.href = 'assistant-apply.html';
        return;
      }

      // Render application details
      const appDetails = document.getElementById('appDetails');
      appDetails.innerHTML = `
        <div class="info-row">
          <span class="info-label">Name</span>
          <span class="info-value">${assistant.name || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Phone</span>
          <span class="info-value">${assistant.phone || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Station</span>
          <span class="info-value">${assistant.station || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Languages</span>
          <span class="info-value">${assistant.languages?.join(', ') || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Applied On</span>
          <span class="info-value">${assistant.applicationDate ? new Date(assistant.applicationDate).toLocaleDateString() : '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Documents</span>
          <span class="info-value">
            ${assistant.aadharFilePath ? '<a href="' + assistant.aadharFilePath + '" target="_blank">Aadhaar</a> ' : ''}
            ${assistant.panFilePath ? '<a href="' + assistant.panFilePath + '" target="_blank">PAN</a> ' : ''}
            ${assistant.photoFilePath ? '<a href="' + assistant.photoFilePath + '" target="_blank">Photo</a>' : ''}
          </span>
        </div>
      `;
    }

    // Auto-refresh for pending status
    setInterval(() => {
      if (applicationData && applicationData.applicationStatus === 'Pending') {
        loadApplicationStatus();
      }
    }, 30000); // Refresh every 30 seconds

    // Initialize
    (async () => {
      await window.RailCareAuth?.enforceRole?.('assistant');
      loadApplicationStatus();
    })();
  </script>
</body>
</html>
